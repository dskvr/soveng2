---
import ImageMod from "@/components/ImageMod.astro";
import BaseNoHeader from "@/layouts/BaseNoHeader.astro";
import { markdownify } from "@/lib/utils/textConverter";
import CallToAction from "@/partials/CallToAction.astro";
import Testimonial from "@/partials/Testimonial.astro";
import type { Button, Feature } from "@/types";
import type { CollectionEntry } from "astro:content";
import { getEntry } from "astro:content";
import { FaCheck } from "react-icons/fa";

interface Homepage {
  banner: {
    title: string;
    content: string;
    image: string;
    button: Button;
  };
  features: Feature[];
}

const homepage = (await getEntry(
  "homepage",
  "-index"
)) as CollectionEntry<"homepage">;

const testimonial = (await getEntry(
  "testimonialSection",
  "testimonial"
)) as CollectionEntry<"testimonialSection">;

const call_to_action = (await getEntry(
  "ctaSection",
  "call-to-action"
)) as CollectionEntry<"ctaSection">;

const { banner, features } = homepage.data as Homepage;

// Pre-process markdown content
const bannerTitle = await markdownify(banner.title);
const bannerContent = await markdownify(banner.content);
---

<BaseNoHeader>
  <!-- Hero Section -->
  <header class="h-screen w-full flex flex-col text-white relative">
    <!-- Header with logo -->
    <div class="flex flex-col sm:flex-row justify-between items-center py-4 px-8 sm:px-16 gap-1 sm:gap-0">
      <div class="text-sm order-2 sm:order-1">Build the tools.</div>
      <img src="/images/sec-05-sec-05-brandmark-white-rgb.svg" alt="Sovereign Engineering" class="w-[2.5rem] sm:w-[3rem] order-1 sm:order-2" />
      <div class="text-sm order-3">Ship the future.</div>
    </div>
    
    <!-- Background image with mix blend mode -->
    <div
      class="absolute inset-0 bg-center bg-no-repeat pointer-events-none"
      style="background-image: url('/images/shining-city-in-cyberspace.png'); image-rendering: pixelated; mix-blend-mode: lighten; z-index: -1;"
    ></div>

    <div class="w-full flex-grow sm:flex-grow-0 text-center py-2 sm:py-16 flex items-center justify-center">
      <h1 class="text-[8vw] sm:text-[6vw] font-bold leading-none">SOVEREIGN ENGINEERING</h1>
    </div>

    <main class="flex-grow">
      <!-- The main content is the background image -->
    </main>

    <footer class="w-full flex flex-col sm:flex-row justify-between items-center p-8 sm:p-16 gap-4 sm:gap-0">
      <div class="text-sm text-center sm:text-left w-full sm:w-1/4 leading-none">
        <p class="m-0 text-balance">
          Six weeks of ideation, experimentation, mentorship, and dialog.
        </p>
      </div>

      <div class="text-center order-first sm:order-none">
        {
          banner.button.enable && (
            <a
              class="btn-retro"
              href={banner.button.link}
              target={
                banner.button.link.startsWith("http") ? "_blank" : "_self"
              }
              rel="noopener"
            >
              {banner.button.label}
            </a>
          )
        }
      </div>

      <div class="text-sm text-center sm:text-right w-full sm:w-1/4 leading-none">
        <p class="m-0 text-balance">
          Build applications, services, and businesses for a self-sovereign future.
        </p>
      </div>
    </footer>
  </header>
  <!-- /Hero Section -->

  <!-- What is this section -->
  <section class="w-full h-full text-white relative bg-black grid grid-cols-1 md:grid-cols-2 p-8 sm:p-16 gap-8">
    <div class="">
      <h2 class="text-3xl">What is this?</h2>
      <p>
        Sovereign Engineering Cohorts (SEC) are groups of focused builders
        who <strong>re think and reimagine the internet</strong>. This is
        not a conference. This is not a hackathon. Neither is this a school,
        or an academy, or a workshop. This is something else.
      </p>
      <p>
        The goal of the Sovereign Engineering Cohort is to bring the best
        and brightest—those who have not given up on the Web or the
        world—together in a beautiful place for a 6 weeks.
      </p>
      <p>
        <em>
          "If you want to build a ship, don't drum up the men to gather
          wood, divide the work, and give orders. Instead,{" "}
          <strong>teach them to yearn for the vast and endless sea.</strong>
          " —Antoine de Saint-Exupéry
        </em>
      </p>
      <p>
        The vast and endless sea is the ocean of possibilities that bitcoin
        & nostr and other freedom technologies open up. The ships are the
        tools we're going to build; the wood is the software we're going to
        write.
      </p>
    </div>
    <div class="bg-primary self-start">
      <img src="/images/men-wanted.png" alt="Men Wanted" class="mix-blend-darken" />
    </div>
  </section>

  <!-- Features -->
  {
    features.map(async (feature, index: number) => {
      const featureTitle = await markdownify(feature.title);
      const featureContent = await markdownify(feature.content);
      const bulletPoints = await Promise.all(
        feature.bulletpoints.map(async (bullet: string) => await markdownify(bullet))
      );
      
      return (
        <section 
          class="section-sm bg-black text-white"
          id={index === 0 ? "what" : index === 1 ? "how" : index === 2 ? "why" : ""}
        >
          <div class="container">
            <div class="row items-center justify-between">
              <div
                class={`mb:md-0 mb-6 md:col-5 ${index % 2 !== 0 && "md:order-2"}`}
              >
                <ImageMod
                  src={feature.image}
                  height={480}
                  width={520}
                  alt={feature.title}
                  format="webp"
                />
              </div>
              <div class={`md:col-7 lg:col-6 ${index % 2 !== 0 && "md:order-1"}`}>
                <h2 set:html={featureTitle} class="mb-4 text-white" />
                <p set:html={featureContent} class="mb-8 text-lg text-white" />
                <ul>
                  {bulletPoints.map((bullet: string) => (
                    <li class="relative mb-4 pl-6 text-white">
                      <FaCheck className={"absolute left-0 top-1.5 text-primary"} />
                      <span set:html={bullet} />
                    </li>
                  ))}
                </ul>
                {feature.button.enable && (
                  <a 
                    class="btn-retro mt-5 inline-block" 
                    href={feature.button.link}
                    target={feature.button.link.startsWith("http") ? "_blank" : "_self"}
                    rel={feature.button.link.startsWith("http") ? "noopener noreferrer" : ""}
                  >
                    {feature.button.label}
                  </a>
                )}
              </div>
            </div>
          </div>
        </section>
      );
    })
  }
  <!-- /Features -->

  <Testimonial testimonial={testimonial} />
  <CallToAction call_to_action={call_to_action} />
</BaseNoHeader>
